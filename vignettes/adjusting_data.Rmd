---
title: "Adjusting data to use with Sicegar"
author: "Thomas Matheis, Phineus Choi, Sam Butler, Jo Hardin"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adjusting data to use with Sicegar}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

There are often cases where data must be manipulated before using with **sicegar**. Two common situations in which adjustments are needed is when the data has too few time points, and when it appears to have a decreasing, or negative, trend. While **sicegar** does not have built-in functions to perform the necessary corrections, the required operations are fairly simple.

```{r install_packages, echo=FALSE, warning=FALSE, results='hide',message=FALSE}

###*****************************
# INITIAL COMMANDS TO RESET THE SYSTEM
seedNo=14159
set.seed(seedNo)
###*****************************

###*****************************
require("sicegar")
require("dplyr")
require("ggplot2")
require("cowplot")
###*****************************
```

We will first demonstrate how to adjust data with too few time points. More specifically, if sigmoidal data has five or fewer time points (six or fewer for double sigmoidal data), **sicegar** will fail to find a fit. This is a result of the sigmoidal and double sigmoidal models having six and seven parameters respectively.

```{r generate_data}
time <- seq(1, 24, 4)
noise_parameter <- 0.2
intensity_noise <- runif(n = length(time), min = 0, max = 1) * noise_parameter
intensity <- doubleSigmoidalFitFormula_h0(time,
                                       finalAsymptoteIntensityRatio = 0.3,
                                       maximum = 10,
                                       slope1Param = 1,
                                       midPoint1Param = 7,
                                       slope2Param = 1,
                                       midPointDistanceParam = 8,
                                       h0 = 2)
intensity <- intensity + intensity_noise
dataInput <- data.frame(time, intensity)
ggplot(dataInput, aes(time, intensity)) + 
  geom_point() + 
  scale_y_continuous(limits = c(0, 12), expand = expansion(mult = c(0, 0))) + 
  theme_bw()
```

The easiest remedy is to add a small jitter in the x-direction, artificially creating many more time points for **sicegar** to work with.

```{r}
dataInput_jitter <- dataInput |>
  mutate(time = jitter(time, amount = 0.5))

dataInput <- rbind(dataInput, dataInput_jitter)
  
ggplot(dataInput, aes(time, intensity)) + 
  geom_point() + 
  scale_y_continuous(limits = c(0, 12), expand = expansion(mult = c(0, 0))) + 
  theme_bw()
```

Now we use our data with `fitAndCategorize` as usual, finding a fit for our model and plot using `figureModelCurves()`:

```{r}
fitObj_jittered <- fitAndCategorize(dataInput,
                           threshold_minimum_for_intensity_maximum = 0.3,
                           threshold_intensity_range = 0.1,
                           threshold_t0_max_int = 0.05,
                           use_h0 = TRUE)

figureModelCurves(dataInput = fitObj_jittered$normalizedInput,
                  doubleSigmoidalFitVector = fitObj_jittered$doubleSigmoidalModel,
                  showParameterRelatedLines = TRUE,
                  use_h0 = TRUE)
```

Next, we will show the process for correcting sigmoidal and double sigmoidal data that appears to have a decreasing/negative trend, or in other words, data that appears to be flipped.

```{r}
time <- seq(1, 24, 0.5)
noise_parameter <- 0.2
intensity_noise <- runif(n = length(time), min = 0, max = 1) * noise_parameter
intensity <- doubleSigmoidalFitFormula_h0(time,
                                       finalAsymptoteIntensityRatio = 0.3,
                                       maximum = 10,
                                       slope1Param = 2,
                                       midPoint1Param = 8,
                                       slope2Param = 3,
                                       midPointDistanceParam = 7,
                                       h0 = 8)
intensity <- intensity + intensity_noise
dataInput <- data.frame(time, intensity)
ggplot(dataInput, aes(time, intensity)) + 
  geom_point() + 
  scale_y_continuous(limits = c(0, 12), expand = expansion(mult = c(0, 0))) + 
  theme_bw()
```

The most straightforward method is to simply reverse the x-axis, resulting in the last time value to become the first time value, etc.

```{r}
dataInput <- dataInput |>
  mutate(time = max(time) - time)

ggplot(dataInput, aes(time, intensity)) + 
  geom_point() + 
  scale_y_continuous(limits = c(0, 12), expand = expansion(mult = c(0, 0))) + 
  theme_bw()
```

Now that the data is corrected, we can again use our data with `fitAndCategorize` as usual to find a fit for our model and plot using `figureModelCurves()`:

```{r}
fitObj_flipped <- fitAndCategorize(dataInput,
                           threshold_minimum_for_intensity_maximum = 0.3,
                           threshold_intensity_range = 0.1,
                           threshold_t0_max_int = 0.05,
                           use_h0 = TRUE)

figureModelCurves(dataInput = fitObj_flipped$normalizedInput,
                  doubleSigmoidalFitVector = fitObj_flipped$doubleSigmoidalModel,
                  showParameterRelatedLines = TRUE,
                  use_h0 = TRUE)
```
