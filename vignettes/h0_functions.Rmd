---
title: "Utilizing _h0 functions of Sicegar"
author: "Tommy Matheis, Phineus Choi, Sam Butler"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Utilizing _h0 functions of Sicegar}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

There may be situations where we want to estimate $h_0$ freely in our model rather than assuming it always starts at zero, which is what **sicegar** assumes by default. For this purpose, the functions `fitAndCategorize()` and `figureModelCurves()` contain the argument `use_h0`. Setting this argument to `TRUE` results in the same process as usual, but utilizing functions ending in `_h0` instead of their default counterparts. For example, the functions `multipleFitFunction()`, `doublesigmoidalFitFormula()`, `parameterCalculation()`, and `normalizeData()` have their `_h0` counterparts, written as `multipleFitFunction_h0()`, `doublesigmoidalFitFormula_h0()`, `parameterCalculation_h0()`, and `normalizeData_h0()`.

```{r install packages, echo=FALSE, warning=FALSE, results='hide',message=FALSE}

###*****************************
# INITIAL COMMANDS TO RESET THE SYSTEM
seedNo=14159
set.seed(seedNo)
###*****************************

###*****************************
require("sicegar")
require("dplyr")
require("ggplot2")
require("cowplot")
###*****************************
```

We will demonstrate the differences between letting $h_0$ be estimated freely and assuming it starts at zero, first generating data where $h_0$ is not zero:

```{r generate both datasets for double - sigmoidal}
time <- seq(3, 24, 0.5)
noise_parameter <- 0.2
intensity_noise <- runif(n = length(time), min = 0, max = 1) * noise_parameter
intensity <- doubleSigmoidalFitFormula_h0(time,
                                       finalAsymptoteIntensityRatio = .3,
                                       maximum = 10,
                                       slope1Param = 1,
                                       midPoint1Param = 7,
                                       slope2Param = 1,
                                       midPointDistanceParam = 8,
                                       h0 = 2)
intensity <- intensity + intensity_noise
dataInput <- data.frame(time, intensity)
ggplot(dataInput, aes(time, intensity)) + 
  geom_point() + 
  scale_y_continuous(limits = c(0, 12), expand = expansion(mult = c(0, 0))) + 
  theme_bw()
```

We now use to `fitAndCategorize()` on our data, once with default arguments and again setting the argument `use_h0` to `TRUE`:

```{r}
fitObj_zero <- fitAndCategorize(dataInput,
                           threshold_minimum_for_intensity_maximum = 0.3,
                           threshold_intensity_range = 0.1,
                           threshold_t0_max_int = 0.05,
                           use_h0 = FALSE)   # Default

fitObj_free <- fitAndCategorize(dataInput,
                           threshold_minimum_for_intensity_maximum = 0.3,
                           threshold_intensity_range = 0.1,
                           threshold_t0_max_int = 0.05,
                           use_h0 = TRUE)
```

Using `figureModelCurves()`, we can visualize the differences between using the default arguments and letting $h_0$ be freely estimated.

```{r fig.height=4, fig.width=8}
# Double-sigmoidal fit with parameter related lines
fig_a <- figureModelCurves(dataInput = fitObj_zero$normalizedInput,
                                  doubleSigmoidalFitVector = fitObj_zero$doubleSigmoidalModel,
                                  showParameterRelatedLines = TRUE,
                                  use_h0 = FALSE)   # Default

fig_b <- figureModelCurves(dataInput = fitObj_free$normalizedInput,
                                  doubleSigmoidalFitVector = fitObj_free$doubleSigmoidalModel,
                                  showParameterRelatedLines = TRUE,
                                  use_h0 = TRUE)

plot_grid(fig_a, fig_b, ncol = 2) # function from the cowplot package
```

It becomes clear that in this situation, using the default arguments would result in a worse fit than when $h_0$ is allowed to be estimated freely.

## Fitting individual models

To fit and plot individual models using a freely estimated $h_0$, we must directly call the `_h0` counterparts of each **sicegar** function. We have already generated the data, so now we can normalize the data.

```{r normalize_data}
normalizedInput <- normalizeData_h0(dataInput = dataInput, 
                                 dataInputName = "doubleSigmoidalSample")
head(normalizedInput$timeIntensityData) # the normalized time and intensity data
```

We can now call `multipleFitFunction_h0()` on our data to be fitted, calculating additional parameters using `parameterCalculation_h0()`:

```{r}
# Do the double-sigmoidal fit
doubleSigmoidalModel <- multipleFitFunction_h0(dataInput=normalizedInput,
                                            model="doublesigmoidal")

doubleSigmoidalModel <- parameterCalculation_h0(doubleSigmoidalModel)
```

Now that we have obtained a fit, we can use `figureModelCurves()` to plot it:

```{r plot raw data and fit, echo=TRUE, message=FALSE, warning=FALSE, comment=FALSE, fig.height=4, fig.width=6}
# double-sigmoidal fit
figureModelCurves(dataInput = normalizedInput,
                  doubleSigmoidalFitVector = doubleSigmoidalModel,
                  showParameterRelatedLines = TRUE,
                  use_h0 = TRUE)
```
